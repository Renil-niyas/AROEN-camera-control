<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AROEN â€“ Telemetry</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="dark">

<header>
  <div class="title-block">
    <h1>AROEN <span class="by">â€“ by Renil Niyas</span></h1>
    <p class="subtitle">
      Autonomous Robot for Odour & Emission Navigation
    </p>
  </div>

  <button id="themeToggle" class="theme-btn">â˜€ / ğŸŒ™</button>
</header>

<main class="grid">

<!-- LEFT PANEL -->
<section class="panel status">

<h2>System Status</h2>
<div class="sensor"><span>Mode</span><strong id="mode">--</strong></div>
<div class="sensor"><span>Status</span>
<strong id="finalStatus">NORMAL</strong></div>

<hr>

<h2>Air Quality</h2>
<div class="sensor"><span>IAQ</span><strong id="iaq">--</strong></div>
<div class="sensor"><span>eCO2</span><strong id="eco2">-- ppm</strong></div>
<div class="sensor"><span>Temp</span><strong id="temp">-- Â°C</strong></div>
<div class="sensor"><span>Humidity</span><strong id="hum">-- %</strong></div>

<hr>

<h2>Orientation</h2>
<div class="sensor"><span>Roll</span><strong id="roll">--Â°</strong></div>
<div class="sensor"><span>Pitch</span><strong id="pitch">--Â°</strong></div>

<div class="orientation-box">
  <div class="cube" id="cube">
    <div class="face front"></div>
    <div class="face back"></div>
    <div class="face left"></div>
    <div class="face right"></div>
    <div class="face top"></div>
    <div class="face bottom"></div>
  </div>
</div>

<hr>

<button onclick="toggleThreshold()" class="threshold-btn">
Set Threshold
</button>

<div id="thresholdContainer" style="display:none;">
<input type="range" id="thresholdSlider"
       min="10" max="100" value="40">
<div style="text-align:center;">
Threshold: <strong id="thresholdValue">40</strong> %
</div>
</div>

</section>

<!-- CAMERA -->
<section class="panel camera">
<h2>Live Camera</h2>
<img src="/video" class="video">
</section>

<!-- MOVEMENT -->
<section class="panel controls">
<h2>Movement</h2>

<div class="controls-grid">
<button data-cmd="FL">â†–</button>
<button data-cmd="FWD">â–²</button>
<button data-cmd="FR">â†—</button>

<button data-cmd="LEFT">â—€</button>
<button class="stop" data-cmd="STOP">â– </button>
<button data-cmd="RIGHT">â–¶</button>

<button data-cmd="BL">â†™</button>
<button data-cmd="BACK">â–¼</button>
<button data-cmd="BR">â†˜</button>
</div>

<div style="display:flex;gap:12px;justify-content:center;margin-top:12px">
<button data-cmd="ROT_L">âŸ²</button>
<button data-cmd="ROT_R">âŸ³</button>
</div>

<p class="control-status">â— READY</p>
</section>

</main>

<script>

/* ===== THEME TOGGLE ===== */
document.getElementById("themeToggle").onclick = () => {
  document.body.classList.toggle("light");
  document.body.classList.toggle("dark");
};

const cube = document.getElementById("cube");
const moveStatus = document.querySelector(".control-status");

/* ===== SENSOR UPDATE ===== */
setInterval(()=>{
 fetch("/sensors")
 .then(r=>r.json())
 .then(d=>{

  if(d.calibrating){
    mode.textContent="CALIBRATING ("+d.remaining+"s)";
  } else {
    mode.textContent="NORMAL MODE";
  }

  iaq.textContent=d.iaq;
  eco2.textContent=d.eco2+" ppm";
  temp.textContent=d.temp+" Â°C";
  hum.textContent=d.hum+" %";

  roll.textContent=d.roll.toFixed(1)+"Â°";
  pitch.textContent=d.pitch.toFixed(1)+"Â°";

  cube.style.transform =
    `rotateX(${d.pitch}deg) rotateY(${d.roll}deg)`;

  finalStatus.textContent=d.status;
  finalStatus.style.color =
    d.status==="HIGH" ? "#ef4444" : "var(--accent)";
 });
},500);

/* ===== THRESHOLD ===== */
function toggleThreshold(){
 thresholdContainer.style.display=
 thresholdContainer.style.display==="none"?"block":"none";
}

thresholdSlider.onchange=()=>{
 thresholdValue.textContent=thresholdSlider.value;
 fetch("/set_threshold/"+thresholdSlider.value);
};

/* ===== MOVEMENT ===== */
document.querySelectorAll("[data-cmd]").forEach(btn => {

  btn.onmousedown = () => {
    fetch("/move/" + btn.dataset.cmd);
    moveStatus.textContent = "â— " + btn.dataset.cmd;
  };

  btn.onmouseup = btn.onmouseleave = () => {
    fetch("/move/STOP");
    moveStatus.textContent = "â— READY";
  };
});

</script>

</body>
</html>
