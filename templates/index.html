<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AROEN â€“ by Renil Niyas</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="dark">

<header>
  <div class="title-block">
    <h1>AROEN <span class="by">â€“ by Renil Niyas</span></h1>
    <p class="subtitle">Autonomous Robot for Odour & Emission Navigation</p>
  </div>
  <button id="themeToggle" class="theme-btn">â˜€ / ğŸŒ™</button>
</header>

<main class="grid">

<!-- SYSTEM STATUS -->
<section class="panel status">
  <h2>System Status</h2>

  <div class="status-item"><span>Network</span><span class="ok">CONNECTED</span></div>
  <div class="status-item"><span>Camera</span><span class="ok">ACTIVE</span></div>
  <div class="status-item"><span>Pi CPU Temperature</span><span class="ok" id="pi_temp">--</span></div>

  <h2>Sensors</h2>
  <div class="sensor"><span>Gas Sensor 1</span><strong id="gas1">--</strong></div>
  <div class="sensor"><span>Gas Sensor 2</span><strong id="gas2">--</strong></div>
</section>

<!-- CAMERA -->
<section class="panel camera">
  <h2>Live Camera Feed</h2>

  <img src="/video" class="video" id="liveFeed">

  <div class="camera-actions">
    <button onclick="captureImage()">ğŸ“¸ Capture</button>
    <button onclick="toggleGallery()">ğŸ“ Gallery</button>
  </div>

  <div class="gallery" id="gallery"></div>
</section>

<!-- MOVEMENT -->
<section class="panel controls">
  <h2>Movement</h2>

  <div class="controls-grid">
    <button data-cmd="FL">â†–</button>
    <button data-cmd="FWD">â–²</button>
    <button data-cmd="FR">â†—</button>

    <button data-cmd="LEFT">â—€</button>
    <button class="stop" data-cmd="STOP">â– </button>
    <button data-cmd="RIGHT">â–¶</button>

    <button data-cmd="BL">â†™</button>
    <button data-cmd="BACK">â–¼</button>
    <button data-cmd="BR">â†˜</button>
  </div>

  <div style="display:flex;gap:12px;justify-content:center;margin-top:12px">
    <button data-cmd="ROT_L">âŸ²</button>
    <button data-cmd="ROT_R">âŸ³</button>
  </div>

  <p class="control-status" id="moveStatus">â— READY</p>
</section>

</main>

<!-- IMAGE MODAL -->
<div id="imageModal" class="modal">
  <img id="modalImg">
  <button class="delete-btn" onclick="deleteImage()">ğŸ—‘ Delete</button>
</div>

<script>
/* ---------------- THEME ---------------- */
document.getElementById("themeToggle").onclick = () => {
  document.body.classList.toggle("light");
  document.body.classList.toggle("dark");
};

/* ---------------- SENSOR UPDATE ---------------- */
setInterval(() => {
  fetch("/sensors").then(r => r.json()).then(d => {
    gas1.textContent = d.gas1 + " ppm";
    gas2.textContent = d.gas2 + " ppm";
    pi_temp.textContent = d.pi_temp
      ? d.pi_temp.toFixed(1) + " Â°C"
      : "--";
  });
}, 1000);

/* ---------------- MOVEMENT ---------------- */
const moveStatus = document.getElementById("moveStatus");

document.querySelectorAll("[data-cmd]").forEach(btn => {
  btn.onmousedown = () => {
    btn.classList.add("active");
    sendCmd(btn.dataset.cmd);
    moveStatus.textContent = "â— " + btn.dataset.cmd;
  };

  btn.onmouseup = btn.onmouseleave = () => {
    btn.classList.remove("active");
    sendCmd("STOP");
    moveStatus.textContent = "â— READY";
  };
});

function sendCmd(cmd){
  fetch("/move/" + cmd);
}

/* ---------------- GALLERY + CAPTURE ---------------- */
const gallery = document.getElementById("gallery");
const modal = document.getElementById("imageModal");
const modalImg = document.getElementById("modalImg");
let currentImage = "";

function captureImage() {
  fetch("/capture").then(() => loadGallery());
}

function toggleGallery() {
  gallery.classList.toggle("show");
  if (gallery.classList.contains("show")) loadGallery();
}

function loadGallery() {
  fetch("/images").then(r => r.json()).then(data => {
    gallery.innerHTML = "";
    data.files.forEach(src => {
      const img = document.createElement("img");
      img.src = src;
      img.onclick = () => openModal(src);
      gallery.appendChild(img);
    });
  });
}

function openModal(src) {
  currentImage = src;
  modalImg.src = src;
  modal.style.display = "flex";
}

function deleteImage() {
  fetch("/delete", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ path: currentImage })
  }).then(() => {
    modal.style.display = "none";
    loadGallery();
  });
}

modal.onclick = e => {
  if (e.target === modal) modal.style.display = "none";
};
</script>

</body>
</html>
